# Install Ubuntu Server

## Installation

Update BIOS, set desired settings. For Dell, find the Service Tag in the BIOS, find latest BIOS on their support website. Deactivate the lid switch. If this option is not available, a workaround in the OS must be found (maybe the lid options in `/etc/UPower/UPower.conf`).

Download [Ubuntu Server 22.04](https://ubuntu.com/download/server). At the time of writing, this is the latest version for which a CIS Benchmark and [Ubuntu Security Guide](https://ubuntu.com/security/certifications/docs/usg/cis) exists.

Flash the ISO image to a USB stick. On Linux this can be achieved e.g. with dd, on Windows you can use [Rufus](https://ubuntu.com/tutorials/create-a-usb-stick-on-windows#1-overview).

Boot from the USB stick with network cable attached and follow the installation process. As type of installation choose `Ubuntu server`. 3rd-party drivers are optional, depending on your hardware it might make sense to activate it.

Create the following logical volumes, with suggested capacities on a 4TB drive (create new volumes with `AVAILABLE DEVICES > Your disk > free space > Create Logical Volume`, arbitrary name, mount point as indicated below):

- /, 25G
- /tmp, 10G
- /srv/nc-data-no-bkp, 700G
- /srv/nc-bkp, 1.3T
- /srv/nc-data, 1.3T
- /var/lib/docker, 50G

Activate Ubuntu Pro (free for private use), install OpenSSH server and no additional packages.

## SSH Authentication

On your PC, create an SSH key with `ssh-keygen` and copy it to the server with 
`ssh-copy-id -i my-key-file.pub <USER>@<HOST>`. Alternatively, put your public SSH key in `.ssh/authorized_keys` on the server. Try to login with your key.

To disable password login, remove the autogenerated config from the installation process:

```bash
sudo rm /etc/ssh/sshd_config.d/50-cloud-init.conf
sudo systemctl reload ssh
```

## Set the screentimeout

Run the following command to turn the screen off after 60s. Any keyboard stroke reactivates it. Is applied only after a reboot.

 ```bash
 sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="consoleblank=60 /' /etc/default/grub
 sudo update-grub
 ```

## Stresstest

To test your hardware, install stress-ng. Run `tmux`, enter the command `stress-ng --sequential 0 --exclude dev --oom-avoid --verify -t 45s | tee stress-ng.log`. This starts each of the ~330 stress tests after each other for 45s each (i. e. total about 4h), of each the number of cpu instances. Exclude the test dev, which brought my Dell 5420 to freeze. Verifies, watch that it doesn't report failed tests.

Hit `Ctrl + B, D` to detach the session, `tmux attach` to reconnect to the session.

Observe output with `tail -f stress-ng.log`.

## Benchmarking

If you wish so, you can run Phoronix test suite for benchmarking your server. Find the latest `.deb` package on https://github.com/phoronix-test-suite/phoronix-test-suite/releases/latest, download it with `wget`.

Install with 

```bash
sudo dpkg -i phoronix*.deb
sudo apt-get install -f
sudo apt install -y php-cli zip build-essential libevent-dev libpcre++-dev dh-autoreconf cmake cmake-data npm sysbench erlang-base default-jre libuuidm-ocaml-dev libexpat1-dev uuid-dev libcurses-ocaml-dev libcurl4-openssl-dev libgmock-dev libmozjs-78-dev liblz4-dev libgflags-dev bison flex mesa-utils vulkan-tools apt-file libzstd-dev lib-readline-dev erlang-dev libbz2-dev php-gd 

# Link install folder to place with a lot! of free space
sudo install -o $(id -u) -g $(id -g) -d /srv/nc-data/phoronix-test-suite
ln -s /srv/nc-data/phoronix-test-suite ~/.phoronix-test-suite 
```

In case you have already applied the CIS security profile you need to make `/tmp` executable temporarily with `sudo mount -o remount,exec /tmp`. You can undo this with `sudo mount -o remount,noexec /tmp`, or it will be fixed on the next boot.

Now the system should be ready to run the whole `pts/server` test suite. However, this takes around two weeks. The following tests should be more than enough, takes 3.5h on my machine.

Run test with

```bash
phoronix-test-suite batch-setup
phoronix-test-suite batch-benchmark pts/apache pts/openssl pts/redis
```

A comparison between two systems can be done by 

```bash
phoronix-test-suite merge-results <results name>
phoronix-test-suite compare-results-two-way <merge results name>
```

Export results with 

```bash
phoronix-test-suite result-file-to-[pdf|html] <results name>
```

The result names are listed if you omit it.

Cleanup
```bash
sudo apt --autoremove purge phoronix-test-suite php-cli zip build-essential libevent-dev libpcre++-dev dh-autoreconf cmake cmake-data npm sysbench erlang-base default-jre libuuidm-ocaml-dev libexpat1-dev uuid-dev libcurses-ocaml-dev libcurl4-openssl-dev libgmock-dev libmozjs-78-dev liblz4-dev libgflags-dev bison flex mesa-utils vulkan-tools apt-file libzstd-dev lib-readline-dev erlang-dev libbz2-dev php-gd 
rm -rf /srv/nc-data/phoronix-test-suite
rm ~/.phoronix-test-suite
```

I am not entirely confident that everything has been cleaned away but nothing broken, you might want to start the installation all over at this point.

## Set timezone

Check it with `cat /etc/timezone`, set it with `sudo timedatectl set-timezone <Your timezone>`. Valid timezones can be seen with `timedatectl list-timezones`.

## Add environment variable with email address

Add an environment variable with the email address where you want to receive server notifications etc. It will be used to configure files lateron.

```bash
read -p "Enter your email address: " ADMIN_EMAIL
export ADMIN_EMAIL="${ADMIN_EMAIL}"
tee -a ~/.profile <<EOF

# This is the system administrators email address
ADMIN_EMAIL="${ADMIN_EMAIL}"
EOF
```

## Set default editor

Set the default editor to the one you're use to with `sudo update-alternatives --config editor`

## Configure battery

If you run on a laptop with a battery (which is a convenient UPS), adjust the settings with the following values. Read & edit the file yourself to adjust it to your needs.

```bash

sudo sed -i 's/CriticalPowerAction=.*/CriticalPowerAction=PowerOff/;s/PercentageCritical=.*/PercentageCritical=12/;s/PercentageAction=.*/PercentageAction=8/' /etc/UPower/UPower.conf

sudo systemctl restart upower
```

It is recommended to test this by setting `PercentageAction` to some value that will occur soon.

For a convenient check of the battery status, you might want to install the following alias:

```bash
echo 'alias battery="upower -i /org/freedesktop/UPower/devices/battery_BAT0"' >> ~/.bash_aliases
. ~/.bash_aliases
```

## Clone this repository

To be able to copy some files, you have to clone this repository to your server. From now on, it is assumed that all commands are run from this directory.

```bash
git clone https://github.com/Faebu93/Private-Cloud.git ~/Private-Cloud
cd ~/Private-Cloud
```

## Install docker


Configure the docker daemon to log to journald by default. This also takes care of log rotation etc. If you do not want to enable IPv6, comment out/remove the second line.

```bash
sudo mkdir /etc/docker
cat << EOF | sudo tee /etc/docker/daemon.json
{
  "log-driver": "journald",
  "default-network-opts": {"bridge":{"com.docker.network.enable_ipv6":"true"}}
}
EOF
```

Install docker from the Docker repositories. Since IPv6 support is not very good in older versions of docker, according to a [dedicated page in the Nextcloud AIO repository](https://github.com/nextcloud/all-in-one/blob/main/docker-ipv6-support.md) at least docker v27.0.1 or newer is required if you want to run docker AIO with IPv6 support.

```bash
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

*Instead*, if you do not use IPv6 and prefer so, you can also install the much older version from the Ubuntu repositories:

```bash
# only install if you didn't install the version from the docker repositories
sudo apt install docker.io docker-buildx docker-compose-v2
```

## Apply CIS security profile

### Manually fix remaining problems

#### Configure nftables

Allow incoming SSH connections, deny everything else

```bash
sudo install -m 700 -d /etc/inet-filter.rules.d
sudo install --mode 600 ./resources/nftables/00-base.rules ./resources/nftables/99-ssh.rules /etc/inet-filter.rules.d
echo 'include "/etc/inet-filter.rules.d/*.rules"' | sudo tee -a /etc/nftables.conf
```

After nftables has been activated (happens in the next steps), see the rules with `sudo nft list ruleset`.

#### Limit users SSH Access

Allow only the principal server user to login via SSH.

```bash
echo "AllowUsers ${USER}" | sudo tee /etc/ssh/sshd_config.d/10-restrict-users.conf
sudo systemctl reload ssh
```

### Apply automatic fixes

Install [Ubuntu Security Guide](https://ubuntu.com/security/certifications/docs/2204/disa-stig/installation)

```shell
sudo apt update
sudo apt install -y ubuntu-advantage-tools
sudo ua enable usg
sudo apt install -y usg
```

Whenever a new USG/CIS version is released, you should regenerate the tailoring file with the following snippet. A few of the rules are disabled since they are not applicable in this setup.

```bash
sudo mkdir -p /opt/private-cloud
sudo usg generate-tailoring cis_level1_server /opt/private-cloud/tailor.xml
sudo chmod 600 /opt/private-cloud/tailor.xml

# Disable rules not applicable in this setup
DISABLED_RULES="xccdf_org.ssgproject.content_rule_sysctl_net_ipv4_ip_forward" # Disabled because might be needed for containers
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_grub2_uefi_password" # Disabled because physical access is not part of the threat model
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_ensure_root_password_configured" # Disabled because physical access is not part of the threat model 
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_kernel_module_usb-storage_disabled" # USB storage is needed for the external backup
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_package_aide_installed" # AIDE only makes sense if config and DB are stored an a different host. Also, it consumes quite some resources. Disable it.
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_aide_build_database" # Dito.
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_aide_periodic_cron_checking" # Dito.
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_aide_check_audit_tool" # Dito.
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_nftables_rules_permanent" # nftables rules *are* permanent, raise an alert though because docker creates transient ones
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_file_permissions_ungroupowned" # some files in the docker volumes/images are necessarily not owned by a local user; DO NOT apply a fix for this, as this messes with the permissions of the data in the nextcloud
DISABLED_RULES="$DISABLED_RULES xccdf_org.ssgproject.content_rule_no_files_unowned_by_user" # Dito.

for RULE in $DISABLED_RULES ; do
  ESCAPED_RULE=$(printf '%s\n' "$RULE" | sed -e 's/[]\/$*.^[]/\\&/g');
  sudo sed -i "/$ESCAPED_RULE/{s/true/false/}" /opt/private-cloud/tailor.xml
done
```

Apply the security profile settings and reboot.

```bash
sudo usg fix --tailoring-file /opt/private-cloud/tailor.xml
sudo reboot now
```

To see the script which applies the fixes, run `sudo usg generate-fix --tailoring-file /opt/private-cloud/tailor.xml --output /tmp/fix.sh`

Note that at this point there are some remaining problems, which will be fixed in the next steps.

### Audit

Audit and copy the report to your local PC

```bash
sudo usg audit --tailoring-file /opt/private-cloud/tailor.xml --html-file /tmp/report.html
sudo chmod o+r /tmp/report.html
```

On your PC, download the file with `scp <User>@<Server>:/tmp/report.html` and verify there are no failed rules. Remove the report with `sudo rm /tmp/report.html`.

## Configure IP addresses

The setup of your IP configuration might differ depending on your setup. You should already have been assigned an IPv4 address via DHCP. You might want to make it permanent in your router setting, or make this assignment static by deleting the file `/etc/netplan/00-installer-config.yaml` and adding a similar file like below for IPv4.

Dynamic IPv6 assignments have been disabled by a rule in the CIS security profile, since listening to and applying IPv6 router announcements might be a security risk. The below snippet adds a static IPv6 address. You have to find your IPv6 prefix in your router (if you have any) and pick an address from this range.

```bash
echo "Your current network configuration"
ip a
read -p "Enter the name of the network interface you want to configure an IPv6 address on (usually starts with eth or enp):" NETWORK_INTERFACE
read -p "Your static IPv6 address with prefix length (e.g. '1f97:1bc1:e360:0195::4/64'): " IPV6_ADDRESS
read -p "IPv6 address of your router within your network (e.g. '1f97:1bc1:e360:0195::1'): " IPV6_ROUTER
sudo tee /etc/netplan/50-ipv6-manual-config.yaml <<EOF
network:
  version: 2
  ethernets:
    $NETWORK_INTERFACE:
      critical: true
      addresses:
        - "$IPV6_ADDRESS"
      routes:
        - to: default
          via: $IPV6_ROUTER
EOF
sudo chmod 600 /etc/netplan/50-ipv6-manual-config.yaml
sudo netplan try
```

Your SSH session might break after this point and you have to reconnect.

You might want to configure additional IP addresses, e. g. to run Nextcloud on a separate IP (and expose it to the internet) and have the other IP free to access other, local services on it.

```bash
read -p "Your secondary static IPv4 address with prefix length (e.g. '192.168.1.3/24'): " IPV4_ADDRESS_2
read -p "Your secondary static IPv6 address with prefix length (e.g. '1f97:1bc1:e360:0195::4/64'): " IPV6_ADDRESS_2
sudo tee /etc/netplan/60-additional-address-config.yaml <<EOF
network:
  version: 2
  ethernets:
    $NETWORK_INTERFACE:
      critical: true
      addresses:
        - "$IPV4_ADDRESS_2"
        - "$IPV6_ADDRESS_2"
EOF
sudo chmod 600 /etc/netplan/60-additional-address-config.yaml
sudo netplan try
```

## Reboot every week

Some consider it a good idea to reboot routinely. This service reboots the system every Sunday at 5am.

```bash
sudo install ./resources/services/reboot.timer /etc/systemd/system
sudo systemctl daemon-reload
sudo systemctl enable reboot.timer
```

## Reboot

To finalize the setup, you should reboot now: `sudo reboot now`
